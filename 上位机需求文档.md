# STM32F407 上位机程序需求文档

## 📋 项目概述

**项目名称**: STM32F407 温度控制系统数据采集上位机  
**STM32端**: 实时采集传感器数据并通过串口发送  
**上位机端**: 接收、解析、存储和显示数据  
**通信方式**: UART串口通信  

---

## 🔌 硬件通信参数

| 参数 | 值 |
|------|-----|
| **串口号** | USART2 (需根据实际连接确定COM口) |
| **波特率** | 115200 |
| **数据位** | 8 |
| **停止位** | 1 |
| **校验位** | 无 (NONE) |
| **流控** | 无 |

---

## 📨 数据格式说明

### 1. JSON格式数据 (传感器数据)

STM32每**500ms**发送一组数据，共3条JSON消息：

#### 消息1: WF5803温度和气压传感器
```json
{"type":"data","sensor":"WF5803","temp":26.30,"press":101.25}
```
- `type`: 固定为 `"data"` (数据类型)
- `sensor`: 固定为 `"WF5803"` (传感器名称)
- `temp`: 浮点数，温度值 (单位: °C)
- `press`: 浮点数，气压值 (单位: kPa)

#### 消息2: NTC温度传感器 ⭐ **重点数据**
```json
{"type":"data","sensor":"NTC","temp":25.60}
```
- `type`: 固定为 `"data"`
- `sensor`: 固定为 `"NTC"` (目标传感器)
- `temp`: 浮点数，NTC温度值 (单位: °C)

#### 消息3: PID控制器输出
```json
{"type":"data","sensor":"PID","output":45.20}
```
- `type`: 固定为 `"data"`
- `sensor`: 固定为 `"PID"`
- `output`: 浮点数，PID控制输出值 (范围: 0-100)

### 2. 普通文本消息 (系统信息)

#### 系统启动信息
```
=== Sensors_and_compute Task Started! ===
=== Voltage Monitor Task Started (Priority: Low) ===
=== USART Receive Task Started (Priority: Realtime) ===
Check interval: 600000 ms (10.0 minutes)
========================================
```

#### 电压监控信息
```
[PERIODIC] Voltage check...
Voltage: 12.50V
```

#### 警告信息
```
!!! LOW VOLTAGE ALERT !!!
Suspending All tasks...
Sensors_and_compute task suspended due to low voltage!
```

#### 调试信息
```
Received byte from USART2: '1' (0x31)
Target temperature set to 50.00°C
Target temperature already at 60.00°C
Kp value increased to 11.00
```

---

## 🎯 上位机核心功能需求

### 功能1: 串口数据接收 ✅

**需求描述**:
- 实时接收STM32发送的所有数据
- 自动识别JSON格式和普通文本格式
- 处理中文和特殊字符 (使用UTF-8编码)
-能通过文件修改串口号和波特率等相关信息

**技术要点**:
```python
ser = serial.Serial('COM3', 115200, timeout=1)
line = ser.readline().decode('utf-8', errors='ignore').strip()
```

---

### 功能2: 消息分类处理 ✅

**需求描述**:
- JSON消息: 解析并保存数据
- 普通文本: 实时打印到控制台

**识别逻辑**:
```python
if line.startswith('{') and line.endswith('}'):
    # JSON消息 - 解析处理
    data = json.loads(line)
    if data['type'] == 'data':
        process_sensor_data(data)
else:
    # 普通文本 - 打印显示
    print(line)
```

---

### 功能3: NTC温度数据存储 ⭐ **核心需求**

**需求描述**:
- 只记录NTC传感器的温度数据
- 每次运行创建新文件 (不覆盖历史数据)
- 添加上位机时间戳 (主机时间)
- 支持后续画图分析

**数据结构**:
```json
{
  "pc_timestamp": "2025-10-20T14:30:25.123456",  // ISO格式时间戳
  "pc_time_sec": 1729412625.123456,              // Unix时间戳(秒)
  "temperature": 25.60                            // NTC温度(°C)
}
```

**文件命名规则**:
- 格式: `ntc_temp_YYYYMMDD_HHMMSS.json`
- 示例: `ntc_temp_20251020_143025.json`
- 保存目录: `./temp_data/` (自动创建)

**文件格式**: JSON数组
```json
[
  {
    "pc_timestamp": "2025-10-20T14:30:25.123456",
    "pc_time_sec": 1729412625.123456,
    "temperature": 25.60
  },
  {
    "pc_timestamp": "2025-10-20T14:30:25.623789",
    "pc_time_sec": 1729412625.623789,
    "temperature": 25.61
  }
]
```

**数据过滤条件**:
```python
if data['type'] == 'data' and data['sensor'] == 'NTC':
    # 只保存NTC温度数据
    save_ntc_temperature(data['temp'])
```

---

### 功能4: 实时数据显示 ✅

**需求描述**:
- 控制台实时显示接收到的数据
- 区分不同类型的消息 (不同颜色/格式)
- 显示数据计数

**显示格式示例**:
```
🔌 串口 COM3 已打开
📊 数据文件: ./temp_data/ntc_temp_20251020_143025.json
📝 日志文件: ./temp_data/system_log_20251020_143025.txt
============================================================
📈 [0001] 2025-10-20 14:30:25 | NTC Temp: 25.60°C
📈 [0002] 2025-10-20 14:30:25 | NTC Temp: 25.61°C
📈 [0003] 2025-10-20 14:30:26 | NTC Temp: 25.59°C
💬 === Voltage Monitor Task Started (Priority: Low) ===
💬 Check interval: 600000 ms (10.0 minutes)
```

---

### 功能5: 程序退出保存 ✅

**需求描述**:
- 按 `Ctrl+C` 优雅退出
- 保存所有已接收的数据到文件
- 显示统计信息 (总记录数)
- 关闭串口连接

**退出流程**:
1. 捕获 `KeyboardInterrupt` 异常
2. 保存数据到JSON文件
3. 显示统计信息
4. 关闭串口
5. 退出程序

**退出信息示例**:
```
⏹️  记录停止!
📊 共记录 1250 条NTC温度数据
✅ 数据已保存: ./temp_data/ntc_temp_20251020_143025.json
✅ 系统日志已保存: ./temp_data/system_log_20251020_143025.txt
🔌 串口已关闭
```

---

## 📊 数据用途

### 目标: 时间-温度关系分析

**分析需求**:
- 绘制温度随时间变化曲线
- 分析温度变化趋势
- 计算温度稳定性
- 评估PID控制效果

**时间基准**: 使用上位机时间戳
- 相对时间: `(当前时间 - 起始时间).total_seconds()`
- 用于X轴: 时间间隔 (秒)
- 用于Y轴: 温度值 (°C)

**绘图数据提取**:
```python
times = [(record['pc_time_sec'] - start_time) for record in data_list]
temps = [record['temperature'] for record in data_list]

plt.plot(times, temps)
plt.xlabel('时间 (秒)')
plt.ylabel('温度 (°C)')
plt.title('NTC温度变化曲线')
```

---

## 🔧 可选功能 (建议实现)

### 1. 系统日志记录
- 记录所有非数据类消息到日志文件
- 文件命名: `system_log_YYYYMMDD_HHMMSS.txt`
- 包含: 启动信息、电压信息、警告、调试信息

### 2. 其他传感器数据存储
- WF5803温度和气压数据
- PID输出数据
- 可选择性保存或忽略

### 3. 数据可视化
- 实时绘制温度曲线 (matplotlib动画)
- 历史数据分析工具
- 多传感器对比显示

### 4. 错误处理
- 串口断开自动重连
- JSON解析错误跳过
- 文件写入异常处理

### 5. 配置文件
- 串口号可配置
- 保存目录可配置
- 数据过滤规则可配置

---

## 📦 推荐实现技术栈

### Python (推荐) ⭐

**核心库**:
```python
import serial           # 串口通信: pyserial
import json             # JSON解析: 内置
from datetime import datetime  # 时间处理: 内置
import os               # 文件操作: 内置
```

**可选库**:
```python
import matplotlib.pyplot as plt  # 数据可视化
import pandas as pd              # 数据分析
import numpy as np               # 数值计算
```

**安装命令**:
```bash
pip install pyserial matplotlib pandas numpy
```

---

## 🎯 数据流程图

```
┌─────────────┐
│  STM32F407  │
│  (传感器)   │
└──────┬──────┘
       │ UART (115200)
       │ 每500ms发送3条JSON
       ↓
┌──────────────────────────────────┐
│         上位机程序                │
│  ┌────────────────────────────┐  │
│  │  1. 串口接收数据            │  │
│  └────────┬───────────────────┘  │
│           ↓                       │
│  ┌────────────────────────────┐  │
│  │  2. 判断消息类型            │  │
│  │     - JSON? → 解析          │  │
│  │     - 文本? → 打印          │  │
│  └────┬───────────────┬────────┘  │
│       ↓               ↓           │
│  ┌─────────┐   ┌──────────────┐  │
│  │ NTC数据 │   │  其他消息    │  │
│  │ 提取    │   │  显示/记录   │  │
│  └────┬────┘   └──────────────┘  │
│       ↓                           │
│  ┌──────────────────────────┐    │
│  │  3. 添加上位机时间戳      │    │
│  └────────┬─────────────────┘    │
│           ↓                       │
│  ┌──────────────────────────┐    │
│  │  4. 保存到JSON文件        │    │
│  │     ntc_temp_*.json      │    │
│  └──────────────────────────┘    │
└──────────────────────────────────┘
       │
       │ Ctrl+C 退出
       ↓
┌──────────────────────────────────┐
│  5. 数据分析/绘图                 │
│     - 读取JSON文件                │
│     - 提取时间和温度              │
│     - 绘制曲线图                  │
└──────────────────────────────────┘
```

---

## ✅ 验收标准

### 基本功能 (必须实现):
- [ ] 能正确打开串口并接收数据
- [ ] 能区分JSON消息和普通文本消息
- [ ] 能正确解析JSON格式的传感器数据
- [ ] 能识别并提取NTC温度数据
- [ ] 能添加上位机时间戳
- [ ] 每次运行创建新的JSON文件
- [ ] 文件名包含日期时间戳
- [ ] 按Ctrl+C能正常退出并保存数据
- [ ] 控制台能实时显示接收到的数据

### 数据质量:
- [ ] 时间戳精度达到毫秒级
- [ ] 温度数据保留2位小数
- [ ] JSON文件格式正确 (可被其他程序读取)
- [ ] 数据完整无丢失

### 用户体验:
- [ ] 程序启动显示配置信息
- [ ] 实时显示数据接收状态
- [ ] 退出时显示统计信息
- [ ] 控制台输出清晰易读

---

## 📝 示例代码框架

```python
"""
STM32F407 温度数据采集上位机
功能: 接收NTC温度数据并保存为JSON文件
"""

import serial
import json
from datetime import datetime
import os

# ========== 配置参数 ==========
SERIAL_PORT = 'COM3'      # 修改为实际串口号
BAUD_RATE = 115200
SAVE_DIR = './temp_data'  # 数据保存目录

# ========== 主程序 ==========
def main():
    # 1. 创建保存目录
    os.makedirs(SAVE_DIR, exist_ok=True)
    
    # 2. 打开串口
    ser = serial.Serial(SERIAL_PORT, BAUD_RATE, timeout=1)
    print(f"🔌 串口 {SERIAL_PORT} 已打开")
    
    # 3. 创建数据文件
    timestamp = datetime.now().strftime('%Y%m%d_%H%M%S')
    filename = os.path.join(SAVE_DIR, f'ntc_temp_{timestamp}.json')
    print(f"📊 数据文件: {filename}")
    print("=" * 60)
    
    ntc_data_list = []
    
    try:
        while True:
            # 4. 接收数据
            line = ser.readline().decode('utf-8', errors='ignore').strip()
            if not line:
                continue
            
            # 5. 处理JSON消息
            if line.startswith('{') and line.endswith('}'):
                data = json.loads(line)
                
                # 6. 提取NTC温度数据
                if data.get('type') == 'data' and data.get('sensor') == 'NTC':
                    now = datetime.now()
                    record = {
                        'pc_timestamp': now.isoformat(),
                        'pc_time_sec': now.timestamp(),
                        'temperature': data['temp']
                    }
                    ntc_data_list.append(record)
                    print(f"📈 [{len(ntc_data_list):04d}] {now.strftime('%H:%M:%S')} | Temp: {record['temperature']:.2f}°C")
            else:
                # 7. 打印普通文本
                print(f"💬 {line}")
    
    except KeyboardInterrupt:
        # 8. 保存数据
        print(f"\n\n⏹️  记录停止!")
        print(f"📊 共记录 {len(ntc_data_list)} 条NTC温度数据")
        
        with open(filename, 'w', encoding='utf-8') as f:
            json.dump(ntc_data_list, f, indent=2, ensure_ascii=False)
        
        print(f"✅ 数据已保存: {filename}")
    
    finally:
        ser.close()
        print("🔌 串口已关闭")

if __name__ == '__main__':
    main()
```

---

## 📌 注意事项

1. **串口号确认**: 
   - Windows: 设备管理器查看 (COM1, COM3, etc.)
   - Linux: 通常为 `/dev/ttyUSB0` 或 `/dev/ttyACM0`
   - Mac: 通常为 `/dev/cu.usbserial-*`

2. **时间精度**: 
   - Python的 `datetime.now()` 精度为微秒级
   - 适合记录500ms间隔的数据

3. **数据采样频率**:
   - STM32发送: 500ms间隔
   - 预期数据量: 120条/分钟, 7200条/小时

4. **文件大小估算**:
   - 每条记录约100字节
   - 1小时约700KB
   - 24小时约16MB

5. **编码问题**:
   - 使用UTF-8编码
   - `errors='ignore'` 避免解码错误

---

## 🚀 快速开始

### 步骤1: 安装依赖
```bash
pip install pyserial
```

### 步骤2: 修改配置
```python
SERIAL_PORT = 'COM3'  # 改为你的串口号
```

### 步骤3: 运行程序
```bash
python stm32_data_logger.py
```

### 步骤4: 停止记录
按 `Ctrl+C` 停止并保存数据

### 步骤5: 查看数据
```bash
# 数据文件位置
./temp_data/ntc_temp_20251020_143025.json
```

---

## 📧 联系与支持

如有问题或需要进一步说明,请参考:
- STM32代码: `e:\program_C\STM32F407-\Core\Src\freertos.c` (第232-234行)
- 数据格式: 见本文档 "数据格式说明" 章节

---

**文档版本**: v1.0  
**创建日期**: 2025-10-20  
**最后更新**: 2025-10-20  
**STM32固件版本**: 基于 freertos.c (混合模式)

---

## 🎉 祝开发顺利！
